# PMF-BLS (bls_ultimate) — 复现指南（Windows）

本文档指导如何在工作区pmfbls 上复现 test_bscdfsl.py 的测试流程（MiniBLS / ProtoNet_Ultimate）。

## 环境
- OS: Windows
- Python: 3.8–3.10
- CUDA: 与驱动匹配（示例 CUDA 11.x）
- 建议使用 conda：
```powershell
conda create -n pmfbls python=3.8 -y
conda activate pmfbls
# 以 CUDA11.3 为例
conda install pytorch torchvision torchaudio cudatoolkit=11.3 -c pytorch -y
pip install -r bls\pmf_cvpr22\requirements.txt
```
按照 requirements.txt安装，至少安装：torch, torchvision, numpy, pillow, pandas, scikit-learn, tqdm, tabulate。

## 代码位置（工作区）
- 测试脚本： bls\pmf_cvpr22\test_bscdfsl.py
- 模型： bls\pmf_cvpr22\models\bls_ultimate.py
- 数据 loader： bls\pmf_cvpr22\datasets\cdfsl\*_few_shot.py

## 数据放置（推荐）
将每个 domain 数据解到项目 data 子目录（或修改 loader 路径常量）：
- 你自己的路径\pmfbls\bls\pmf_cvpr22\data\EuroSAT\2750\...
- 你自己的路径\pmfbls\bls\pmf_cvpr22\data\ISIC\...
- 你自己的路径\pmfbls\bls\pmf_cvpr22\data\CropDisease\...
- 你自己的路径\pmfbls\bls\pmf_cvpr22\data\ChestX\...

目录要求：每类一个子文件夹，内含图片；如使用 csv/json 划分，参照各 domain 的 few_shot loader。

## 运行（推荐在脚本目录）
1. 进入脚本目录：
```powershell
cd c:\Users\李维志\Desktop\pmfbls\bls\pmf_cvpr22
```
2. （可选）指定 GPU：
```powershell
$env:CUDA_VISIBLE_DEVICES = "0"
```
3. 运行你的命令（直接可用）：
```powershell
python test_bscdfsl.py --cdfsl_domains EuroSAT CropDisease ChestX ISIC --deploy mini_bls --arch dino_small_patch16 --mini_bls_mlf_enable --mini_bls_mlf_layers=-2,-5,-8 --mini_bls_cov_enable --mini_bls_cov_proj_dim 32 --mini_bls_cov_power 0.5 --mini_bls_cov_eps 1e-4 --mini_bls_mapping_dim 1024 --mini_bls_reg_lambda 0.01 --test_n_way 5 --n_shot 5 --nEpisode 600 --batch-size 4 --num_workers 0 --output_dir outputs/inductive_baseline
```
- 若从 repo 根运行，前面加脚本路径： `python bls\pmf_cvpr22\test_bscdfsl.py ...`

## 输出
- 输出目录由 `--output_dir` 指定（示例： outputs\inductive_baseline）
- 主要文件： `log_test_{deploy}_{train_tag}.txt`, `test_results_{deploy}_{train_tag}.npy`
- 日志包含每个 domain 的 acc 与置信区间

## 脚本行为要点（基于 test_bscdfsl.py）
- 脚本强制 eval 模式、FP32（args.eval=True, args.fp16=False）。
- `args.distributed=False`；Windows 推荐 `--num_workers 0`。
- 若传入 `--resume`，脚本会尝试“智能”加载 checkpoint，仅加载 backbone 权重（允许 head/BLS 缺失）。
- 若使用 `--deploy finetune`，脚本会在若干 lr 值上验证并自动选择 best_lr。
- 随机性由 args.seed 控制，脚本会设置 torch/np/random 种子以提高可复现性。

## 常见问题与解决
- 数据路径报错：检查 domain loader 中路径常量或将数据放到上面建议位置。
- DataLoader 在 Windows 异常：务必使用 `--num_workers 0`；确认脚本入口在 `if __name__ == "__main__":`。
- checkpoint 加载缺少 keys：这是正常（Head/BLS 层通常无 pretrain），只需确保 backbone 部分成功加载。
- 显存不足：减小 `--batch-size` 或关闭额外模块（如 TTA）。
- 想固定结果：在命令或脚本中指定 `--seed` 并在脚本里保持随机种子设置（test_bscdfsl.py 已处理）。

